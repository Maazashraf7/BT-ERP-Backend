generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////
// TENANT
//////////////////////////////
model Tenant {
  id        String     @id @default(uuid())
  name      String
  type      TenantType

  // Platform control (Super Admin)
  isActive  Boolean    @default(true)
  createdAt DateTime  @default(now())

  // Relations
  users         User[]
  roles         Role[]
  modules       TenantModule[]
  subscriptions Subscription[]
  auditLogs     AuditLog[]

  // Tenant-managed
  profile   TenantProfile?
  settings  TenantSetting[]
}

enum TenantType {
  SCHOOL
  COACHING
  CLINIC
  PHARMACY
  RETAIL
  RESTAURANT
  GYM
  SALON
}

//////////////////////////////
// TENANT PROFILE (Branding)
//////////////////////////////
model TenantProfile {
  id        String @id @default(uuid())
  tenantId  String @unique

  logoUrl    String?
  faviconUrl String?
  themeColor String?

  email     String?
  phone     String?
  address   String?
  website   String?

  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

//////////////////////////////
// TENANT SETTINGS (Flexible)
//////////////////////////////
model TenantSetting {
  tenantId String
  key      String
  value    Json

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([tenantId, key])
}

//////////////////////////////
// USERS
//////////////////////////////
model User {
  id       String @id @default(uuid())
  email    String
  password String

  tenantId String?
  roleId   String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  role   Role?   @relation(fields: [roleId], references: [id])

  @@unique([email, tenantId])
}

//////////////////////////////
// ROLES & PERMISSIONS (RBAC)
//////////////////////////////
model Role {
  id   String @id @default(uuid())
  name String

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  users       User[]
  permissions RolePermission[]
}

model Permission {
  id  String @id @default(uuid())
  key String @unique

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}
//////////////////////////////
// MODULE SYSTEM (UPDATED)
//////////////////////////////
model Module {
  id        String @id @default(uuid())
  key       String @unique
  name      String

  // NEW
  isCommon  Boolean @default(false)

  tenants     TenantModule[]
  planModules PlanModule[]
  tenantTypes ModuleTenantType[]
}

model ModuleTenantType {
  moduleId   String
  tenantType TenantType

  module Module @relation(fields: [moduleId], references: [id])

  @@id([moduleId, tenantType])
}

model TenantModule {
  tenantId String
  moduleId String
  enabled  Boolean @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  module Module @relation(fields: [moduleId], references: [id])

  @@id([tenantId, moduleId])
}



//////////////////////////////
// SUBSCRIPTION & BILLING
//////////////////////////////
model Plan {
  id       String  @id @default(uuid())
  name     String  @unique      // TRIAL | BASIC | PRO
  price    Int                 // paise
  duration Int                 // days
  isActive Boolean @default(true)

  modules       PlanModule[]
  subscriptions Subscription[]
}

model PlanModule {
  planId   String
  moduleId String

  plan   Plan   @relation(fields: [planId], references: [id])
  module Module @relation(fields: [moduleId], references: [id])

  @@id([planId, moduleId])
}

model Subscription {
  id       String @id @default(uuid())
  tenantId String
  planId   String

  status    SubscriptionStatus
  startDate DateTime
  endDate   DateTime

  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan   Plan   @relation(fields: [planId], references: [id])

  @@index([tenantId])
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

//////////////////////////////
// AUDIT LOGS (CRITICAL)
//////////////////////////////
model AuditLog {
  id        String   @id @default(uuid())

  actorId   String?
  actorType ActorType   // SUPER_ADMIN | TENANT_USER

  tenantId  String?
  action    String      // USER_CREATED, TENANT_DISABLED
  entity    String      // USER, TENANT, MODULE
  entityId  String?

  meta      Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([action])
}

enum ActorType {
  SUPER_ADMIN
  TENANT_USER
}
