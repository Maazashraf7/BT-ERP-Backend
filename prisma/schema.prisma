generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//

// e.g., SuperAdmin, GlobalSettings, etc.
//

model SuperAdmin {
  id       String @id @default(uuid())
  email    String @unique
  password String

  name     String?
  isActive Boolean @default(true)

  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?

  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  auditLogs     AuditLog[]
  loginAttempts LoginAttempt[]
}

//////////////////////////////
// TENANT
//////////////////////////////

model Tenant {
  id   String     @id @default(uuid())
  name String
  type TenantType

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users         User[]
  roles         Role[]
  modules       TenantModule[]
  subscriptions Subscription[]
  auditLogs     AuditLog[]
  loginAttempts LoginAttempt[]

  profile  TenantProfile?
  settings TenantSetting[]
}

enum TenantType {
  SCHOOL
  COACHING
  CLINIC
  PHARMACY
  RETAIL
  RESTAURANT
  GYM
  SALON
}

//////////////////////////////
// TENANT PROFILE (Branding)
//////////////////////////////
model TenantProfile {
  id       String @id @default(uuid())
  tenantId String @unique

  logoUrl    String?
  faviconUrl String?
  themeColor String?

  email   String?
  phone   String?
  address String?
  website String?

  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

//////////////////////////////
// TENANT SETTINGS (Flexible)
//////////////////////////////
model TenantSetting {
  tenantId String
  key      String
  value    Json

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([tenantId, key])
}

//////////////////////////////
// USERS
//////////////////////////////
model User {
  id       String @id @default(uuid())
  email    String
  password String

  name     String?
  isActive Boolean @default(true)

  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?

  tenantId String
  roleId   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role   Role?  @relation(fields: [roleId], references: [id])

  auditLogs     AuditLog[]
  loginAttempts LoginAttempt[]

  @@unique([email, tenantId])
  @@index([tenantId])
}

//////////////////////////////
// ROLES & PERMISSIONS (RBAC)
//////////////////////////////
model Role {
  id       String @id @default(uuid())
  name     String
  tenantId String

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  users       User[]
  permissions RolePermission[]

  @@unique([name, tenantId])
}

model Permission {
  id  String @id @default(uuid())
  key String @unique

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

//////////////////////////////
// MODULE SYSTEM (UPDATED)
//////////////////////////////
model Module {
  id       String  @id @default(uuid())
  key      String  @unique
  name     String
  isCommon Boolean @default(false)

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  tenants     TenantModule[]
  planModules PlanModule[]
  tenantTypes ModuleTenantType[]
}

model ModuleTenantType {
  moduleId   String
  tenantType TenantType

  module Module @relation(fields: [moduleId], references: [id])

  @@id([moduleId, tenantType])
}

model TenantModule {
  tenantId String
  moduleId String

  enabled   Boolean      @default(true)
  source    ModuleSource @default(PLAN)
  limit     Int?
  expiresAt DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  module Module @relation(fields: [moduleId], references: [id], onDelete: Restrict)

  @@id([tenantId, moduleId])
  @@index([tenantId])
  @@index([moduleId])
}

enum ModuleSource {
  PLAN // from subscription plan
  ADDON // purchased separately
  TRIAL // temporary
  MANUAL // admin override
}

//////////////////////////////
// SUBSCRIPTION & BILLING
//////////////////////////////
model Plan {
  id       String  @id @default(uuid())
  name     String  @unique // TRIAL | BASIC | PRO
  price    Int // paise
  duration Int // days
  isActive Boolean @default(true)

  modules       PlanModule[]
  subscriptions Subscription[]
}

model PlanModule {
  planId   String
  moduleId String

  plan   Plan   @relation(fields: [planId], references: [id])
  module Module @relation(fields: [moduleId], references: [id])

  @@id([planId, moduleId])
}

model Subscription {
  id       String @id @default(uuid())
  tenantId String
  planId   String

  status    SubscriptionStatus
  startDate DateTime
  endDate   DateTime

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@index([tenantId])
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

//////////////////////////////
// AUDIT LOGS (CRITICAL)
//////////////////////////////
model AuditLog {
  id String @id @default(uuid())

  actorType ActorType
  tenantId  String?

  // Separate actor FKs (FIX)
  superAdminId String?
  userId       String?

  action   String
  entity   String
  entityId String?
  meta     Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  tenant     Tenant?     @relation(fields: [tenantId], references: [id])
  superAdmin SuperAdmin? @relation(fields: [superAdminId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([actorType])
  @@index([action])
}

model LoginAttempt {
  id String @id @default(uuid())

  actorType ActorType
  tenantId  String?

  superAdminId String?
  userId       String?

  email   String
  success Boolean
  reason  String?

  ipAddress String?
  userAgent String?
  device    String?

  createdAt DateTime @default(now())

  tenant     Tenant?     @relation(fields: [tenantId], references: [id])
  superAdmin SuperAdmin? @relation(fields: [superAdminId], references: [id])
  user       User?       @relation(fields: [userId], references: [id])

  @@index([email])
  @@index([actorType])
  @@index([tenantId])
  @@index([createdAt])
}

enum ActorType {
  SUPER_ADMIN
  TENANT_USER
}
